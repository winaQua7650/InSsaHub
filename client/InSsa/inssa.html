<html>
  <head>
    <meta charset="utf-8" />
    <title>InSsaHub</title>

    <!-- a-frame -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- socket -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.slim.js"></script>
    <!-- easyrtc -->
    <script src="/easyrtc/easyrtc.js"></script>
    <!-- networked-aframe -->
    <script src="/dist/networked-aframe.js"></script>
    <!-- aframe-color-random -->
    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@master/dist/aframe-particle-system-component.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>

    <!-- aframe-color-component -->
    <script src="/js/color-changer.component.js"></script>
    <!-- loading.js (loading-spinner)-->
    <script defer src="./js/loading.js"></script>
    <!-- bundle.js (a-frame pysics)-->
    <script src="/js/bundle.js"></script>
    <!-- a-frame extra(a-frame pysics) -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/loading.css" />
    <script>
      NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;
      var avatar = localStorage.getItem("avatar");
      NAF.schemas.getComponents = (template) => {
        if (!NAF.schemas.hasTemplate("#avatar-template2")) {
          if (avatar === "dove") {
            document
              .querySelector("#player")
              .setAttribute(
                "networked",
                "template:#avatar-template2;attachTemplateToLocal:false;"
              );
            NAF.schemas.add({
              template: "#avatar-template",
              components: [
                "position",
                "rotation",
                {
                  selector: ".head",
                  component: "material",
                  property: "color",
                },
              ],
            });
          } else if (avatar === "mallardDuck") {
            document
              .querySelector("#player")
              .setAttribute(
                "networked",
                "template:#avatar-template;attachTemplateToLocal:false;"
              );
            NAF.schemas.add({
              template: "#avatar-template2",
              components: [
                "position",
                "rotation",
                {
                  selector: ".head",
                  component: "material",
                  property: "color",
                },
              ],
            });
          }
        }
        if (!NAF.schemas.hasTemplate("#sphere-template")) {
          NAF.schemas.add({
            template: "#sphere-template",
            components: [
              "position",
              {
                component: "material",
                property: "color",
              },
            ],
          });
        }
        const components = NAF.schemas.getComponentsOriginal(template);
        return components;
      };

      // Aframe 컴포넌트 등록되어있는거 가져오기
      AFRAME.registerComponent('glow', {
        schema: {
          color: {
            default: '#ffffff',
            type: 'color'
          },
          intensity: {
            default: 1.0
          }
        },
        init: function () {
          this.el.addEventListener('object3dset', function () {
            this.update();
          }.bind(this));
        },
        update: function () {
          var data = this.data;
          this.el.object3D.traverse(function (node) {
            if (node.isMesh) {
              node.material.emissive.copy(new THREE.Color(data.color));
              node.material.emissiveIntensity = data.intensity;
            }
          });
        }
      });

      /**
       * Simple spin-and-levitate animation.
       */
      AFRAME.registerComponent('levitate', {
        tick: function (t, dt) {
          var mesh = this.el.getObject3D('mesh');
          if (!mesh) return;
          mesh.rotation.y += 0.1 * dt / 1000;
          mesh.position.y = 0.25 * Math.sin(t / 1000);
        }
      });

      /**
       * Removes current element if on a mobile device.
       */
      AFRAME.registerComponent('not-mobile', {
        init: function () {
          var el = this.el;
          if (el.sceneEl.isMobile) {
            el.parentEl.remove(el);
          }
        }
      });
    </script>
  </head>

  
  <body>
    <!-- 로딩스피너 -->
    <div id="loading">
      <img class="loading-spinner" src="./img/loader.gif" alt="loader">
      <div class="loading-text">로딩중입니다, 잠시만 기다려주세요...</div>
    </div>

    <!-- 메인화면 -->
    <a-scene
      id="main-scene"
      networked-scene="
      room: basic-audio;
      debug: true;
      adapter: easyrtc;
      audio: true;
    "
      cursor="rayOrigin: mouse"
      raycaster="objects:.raycastable">
      <!-- 메인 배경 -->
      <a-assets>
        <!-- navmesh -->
        <a-asset-item id="navmesh" src="./assets/gltf/navmesh.glb"></a-asset-item>
        <a-asset-item id="house" src="./assets/gltf/house.glb"></a-asset-item>
      </a-assets>

      <!-- 상호작용 공 -->
      <template id="sphere-template">
        <a-entity
          class="raycastable"
          geometry="primitive: sphere"
          material="color: red"
          color-changer
        ></a-entity>
      </template>

      <!-- 상호작용 entity -->
      <a-entity
        id="sphere"
        networked="template:#sphere-template;networkId:sphere;persistent:true;owner:scene"
      ></a-entity>
     
      <!-- Player1. -->

      <template id="avatar-template">
        <a-entity class="avatar" 
        networked-audio-source>
          <a-gltf-model
            id="myAvatar"
            src="./assets/gltf/mallardDuck.gltf"
            visible="true"
            scale="1 1 1"
          ></a-gltf-model>

        </a-entity>
      </template>

       <!-- Player2. -->
      <template id="avatar-template2">
        <a-entity class="avatar" networked-audio-source >
          <a-gltf-model
            id="myAvatar"
            src="./assets/gltf/dove.gltf"
            visible="true"
            scale="1 1 1"
          ></a-gltf-model>
        </a-entity>
      </template>

      <!-- Player entity. -->
      <a-entity id="player"
      look-controls
        networked="template:#avatar-template;attachTemplateToLocal:false;"
        movement-controls="constrainToNavMesh: true;
                            controls: checkpoint, gamepad, trackpad, keyboard, touch;"
                            >
        <a-entity camera
                  position="0 5.6 0">
        </a-entity>
      </a-entity>

      <!-- Nav mesh. -->
      <a-entity nav-mesh
                normal-material
                visible="false"
                gltf-model="#navmesh"></a-entity>

      <!-- Scene. -->
      <a-entity position="0 0 0"
                gltf-model="#house">
      </a-entity>

        <!-- Templates -->
      
    </a-scene>

    <div class="actions">
      <button id="mic-btn" type="button" class="button">Mute Mic</button>
    </div>

    <script>
      // Mic status
      let micEnabled = true;
      // Mic button ele
      const micBtnEle = document.getElementById("mic-btn");
      // On mobile remove elements that are resource heavy
      const isMobile = AFRAME.utils.device.isMobile();

      if (isMobile) {
        const particles = document.getElementById("particles");
        particles.parentNode.removeChild(particles);
      }
    </script>

    <script>
      // Define custom schema for syncing avatar color, set by random-color

      // Called by Networked-Aframe when connected to server
      function onConnect() {
        console.error("On connected to NAF -", new Date());

        // Handle mic button click (Mute and Unmute)
        micBtnEle.addEventListener("click", function () {
          NAF.connection.adapter.enableMicrophone(!micEnabled);
          micEnabled = !micEnabled;
          micBtnEle.textContent = micEnabled ? "Mute Mic" : "Unmute Mic";
        });

        // Examples of listening to NAF events
        document.body.addEventListener("connected", function (evt) {
          console.error("connected event. clientId =", evt.detail.clientId);
        });

        document.body.addEventListener("clientConnected", function (evt) {
          console.error(
            "clientConnected event. clientId =",
            evt.detail.clientId
          );
        });

        document.body.addEventListener("clientDisconnected", function (evt) {
          console.error(
            "clientDisconnected event. clientId =",
            evt.detail.clientId
          );
        });

        document.body.addEventListener("entityCreated", function (evt) {
          console.error("entityCreated event", evt.detail.el);
        });

        document.body.addEventListener("entityRemoved", function (evt) {
          console.error(
            "entityRemoved event. Entity networkId =",
            evt.detail.networkId
          );
        });
      }
    </script>
    <script>
      document.addEventListener("keydown", flytoggle, false);
      function flytoggle(e) {
        if (e.keyCode === 71) {
          if (
            document.getElementById("player").getAttribute("movement-controls")
              .fly == true
          ) {
            console.log("비행비활성화");
            document
              .getElementById("player")
              .setAttribute("movement-controls", "fly: false; speed: 0.9");
            document.getElementById("cam").setAttribute("rotation", "0 0 0");
            document.getElementById("player").setAttribute("position", "0 2 0");
            document.getElementById("player").setAttribute("rotation", "0 0 0");
          } else {
            console.log("비행활성화");
            document
              .getElementById("player")
              .setAttribute("movement-controls", "fly: true; speed: 0.9");
          }
        }
      }
    </script>
  </body>
</html>
