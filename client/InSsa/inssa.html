<html>
  <head>
    <meta charset="utf-8" />
    <title>Positional Audio Example — Networked-Aframe</title>
    <meta name="description" content="Dev Example — Networked-Aframe" />
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.slim.js"></script>
    <script src="/easyrtc/easyrtc.js"></script>
    <script src="/dist/networked-aframe.js"></script>
    
    
    <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
    <!--<script src="https://unpkg.com/aframe-particle-system-component@1.0.5/dist/aframe-particle-system-component.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@master/dist/aframe-particle-system-component.min.js"></script>
    <script src="/js/spawn-in-circle.component.js"></script>
    <script src="/js/color-changer.component.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
    <script defer src="./js/loading.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/loading.css" />
    <script>
      NAF.schemas.getComponentsOriginal = NAF.schemas.getComponents;
      var avatar = localStorage.getItem("avatar");
      NAF.schemas.getComponents = (template) => {
        if (!NAF.schemas.hasTemplate("#avatar-template2")) {
          if (avatar === "spongeBob") {
            document
              .querySelector("#player")
              .setAttribute(
                "networked",
                "template:#avatar-template2;attachTemplateToLocal:false;"
              );
            NAF.schemas.add({
              template: "#avatar-template",
              components: [
                "position",
                "rotation",
                {
                  selector: ".head",
                  component: "material",
                  property: "color",
                },
              ],
            });
          } else if (avatar === "star") {
            document
              .querySelector("#player")
              .setAttribute(
                "networked",
                "template:#avatar-template;attachTemplateToLocal:false;"
              );
            NAF.schemas.add({
              template: "#avatar-template2",
              components: [
                "position",
                "rotation",
                {
                  selector: ".head",
                  component: "material",
                  property: "color",
                },
              ],
            });
          }
        }
        if (!NAF.schemas.hasTemplate("#sphere-template")) {
          NAF.schemas.add({
            template: "#sphere-template",
            components: [
              "position",
              {
                component: "material",
                property: "color",
              },
            ],
          });
        }
        const components = NAF.schemas.getComponentsOriginal(template);
        return components;
      };
    </script>
  </head>
  <body>
    <!-- 로딩스피너 -->
    <div id="loading">
      <img class="loading-spinner" src="./img/loader.gif" alt="loader">
      <div class="loading-text">로딩중입니다, 잠시만 기다려주세요...</div>
    </div>

    <!-- 메인화면 -->
    <a-scene
      id="main-scene"
      networked-scene="
      room: basic-audio;
      debug: true;
      adapter: easyrtc;
      audio: true;
    "
      cursor="rayOrigin: mouse"
      raycaster="objects:.raycastable"
    >
      <!-- 건축물 -->
      <a-gltf-model src="./assets/gltf/house.gltf"></a-gltf-model>
      <a-assets>

        <!-- Templates -->
        <template id="sphere-template">
          <a-entity
            class="raycastable"
            geometry="primitive: sphere"
            material="color: red"
            color-changer
          ></a-entity>
        </template>

        <!-- Avatar -->
        <template id="avatar-template">
          <a-entity class="avatar" networked-audio-source>
            <a-gltf-model
              id="myAvatar"
              src="./assets/gltf/duck.gltf"
              visible="true"
            ></a-gltf-model>
            <a-text
              id="nickname"
              value="hihihihi"
              position="0.3 1 0"
              color="black"
              rotation="0 180 0"
            ></a-text>
            <a-text
              id="nickname"
              value="hihihihi"
              position="-0.3 1 0"
              color="black"
            ></a-text>
          </a-entity>
        </template>
        <template id="avatar-template2">
          <a-entity class="avatar" networked-audio-source>
            <a-gltf-model
              id="myAvatar"
              src="./assets/gltf/fox.gltf"
              visible="true"
            ></a-gltf-model>
            <a-text
              id="nickname"
              value="hihihihi"
              position="0.3 1 0"
              color="black"
              rotation="0 180 0"
            ></a-text>
            <a-text
              id="nickname"
              value="hihihihi"
              position="-0.3 1 0"
              color="black"
            ></a-text>
          </a-entity>
        </template>

        <!-- /Templates -->
      </a-assets>

      <a-entity
        id="player"
        networked="template:#avatar-template;attachTemplateToLocal:false;"
        camera
        position="0 2 0"
        spawn-in-circle="radius:3"
        wasd-controls
        look-controls
      >
        <a-sphere class="head" visible="false" random-color></a-sphere>
      </a-entity>

      <a-entity
        id="sphere"
        networked="template:#sphere-template;networkId:sphere;persistent:true;owner:scene"
      ></a-entity>

      <a-entity
        position="0 0 0"
        geometry="primitive: plane; width: 10000; height: 10000;"
        rotation="-90 0 0"
        material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;"
      ></a-entity>
    </a-scene>

    <style>
      .github-corner:hover .octo-arm {
        animation: octocat-wave 560ms ease-in-out;
      }
      @keyframes octocat-wave {
        0%,
        100% {
          transform: rotate(0);
        }
        20%,
        60% {
          transform: rotate(-25deg);
        }
        40%,
        80% {
          transform: rotate(10deg);
        }
      }
      @media (max-width: 500px) {
        .github-corner:hover .octo-arm {
          animation: none;
        }
        .github-corner .octo-arm {
          animation: octocat-wave 560ms ease-in-out;
        }
      }
    </style>

    <div class="actions">
      <button id="mic-btn" type="button" class="button">Mute Mic</button>
    </div>

    <script>
      // Mic status
      let micEnabled = true;
      // Mic button ele
      const micBtnEle = document.getElementById("mic-btn");
      // On mobile remove elements that are resource heavy
      const isMobile = AFRAME.utils.device.isMobile();

      if (isMobile) {
        const particles = document.getElementById("particles");
        particles.parentNode.removeChild(particles);
      }
    </script>

    <script>
      // Define custom schema for syncing avatar color, set by random-color

      // Called by Networked-Aframe when connected to server
      function onConnect() {
        console.error("On connected to NAF -", new Date());

        // Handle mic button click (Mute and Unmute)
        micBtnEle.addEventListener("click", function () {
          NAF.connection.adapter.enableMicrophone(!micEnabled);
          micEnabled = !micEnabled;
          micBtnEle.textContent = micEnabled ? "Mute Mic" : "Unmute Mic";
        });

        // Examples of listening to NAF events
        document.body.addEventListener("connected", function (evt) {
          console.error("connected event. clientId =", evt.detail.clientId);
        });

        document.body.addEventListener("clientConnected", function (evt) {
          console.error(
            "clientConnected event. clientId =",
            evt.detail.clientId
          );
        });

        document.body.addEventListener("clientDisconnected", function (evt) {
          console.error(
            "clientDisconnected event. clientId =",
            evt.detail.clientId
          );
        });

        document.body.addEventListener("entityCreated", function (evt) {
          console.error("entityCreated event", evt.detail.el);
        });

        document.body.addEventListener("entityRemoved", function (evt) {
          console.error(
            "entityRemoved event. Entity networkId =",
            evt.detail.networkId
          );
        });
      }
    </script>
  </body>
</html>
